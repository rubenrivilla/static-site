<!doctype html>
<html lang="es">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="https://www.dgt.es/favicon.ico">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Cámaras DGT</title>
</head>

<body class="bg-secondary">
    <nav class="navbar navbar-light bg-warning">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://www.dgt.es/.content/.assets/logo_dgt.svg" alt="" width="30" height="24"
                    class="d-inline-block align-text-top">
                Cámaras DGT
            </a>
            <!-- <span id="countdown">30</span> -->
            <button id="countdown" type="button" class="btn btn-success">Start</button>
        </div>
    </nav>

    <div class="container-fluid p-2">
        <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" aria-label="Loading" style="width: 0%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <div class="container-fluid">
        <div id="cameras" class="row">
        </div>
        <div id="info" class="row">
        </div>
    </div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <!-- Custom -->
    <script type="module">
        const INTERVAL_TIME = 300;

        let progress = 0;
        let itervalId;
        let interval = INTERVAL_TIME;
        let countdown_activated = false;

        Number.prototype.toHHMMSS = function () {
            let hours   = Math.floor(this / 3600);
            let minutes = Math.floor((this - (hours * 3600)) / 60);
            let seconds = this - (hours * 3600) - (minutes * 60);

            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        }

        function countdown() {
            interval -= 1;
            document.getElementById("countdown").textContent = interval.toHHMMSS();
            if (interval == 0) {
                interval = INTERVAL_TIME;
                loadPage();
            }
        }

        function toggleCountdown() {
            if (countdown_activated) {
                countdown_activated = false;
                clearInterval(itervalId);
                document.getElementById("countdown").classList.remove("btn-danger");
                document.getElementById("countdown").classList.add("btn-success");
                document.getElementById("countdown").textContent = 'Start';
            } else {
                countdown_activated = true;
                document.getElementById("countdown").classList.remove("btn-success");
                document.getElementById("countdown").classList.add("btn-danger");
                document.getElementById("countdown").textContent = interval.toHHMMSS();
                itervalId = setInterval(countdown, 1000);
            }
        }

        function setProgress(prg) {
            progress = prg
            progress = progress > 100 ? 100 : progress;
            let progress_bar = document.getElementById("progress-bar");
            progress_bar.style.width = progress+'%';
            progress_bar.textContent = progress+'%';
        }

        function addProgress(plus) {
            setProgress(progress + plus)
        }
        
        function loadPage() {
            // init
            setProgress(0);

            // date
            let date = new Date();
            let timestamp = date.getTime();
            let datestr = date.toLocaleString();
            addProgress(10);

            // meteos
            let meteos = [
                {alias: "CL-601 Pk 10.8 D", carretera: "CL-601", codEle: "GUID_MET_70393", url: ""},
                {alias: "CL-601 Pk 24.0 C", carretera: "CL-601", codEle: "GUID_MET_70394", url: ""},
            ]
            document.getElementById("info").innerHTML = '';
            meteos.forEach(sensor => {
                sensor.url = 'https://infocar.dgt.es/etraffic/BuscarElementos?accion=getDetalles&codEle='+sensor.codEle+'&tipo=SensorMeteorologico&indiceMapa=0'
                let headers = new Headers();
                headers.append('Accept', 'application/json');
                headers.append('Content-Type', 'text/plain; charset=UTF-8');
                //let request = new Request('https://proxy.cors.sh/'+sensor.url, {method: 'GET', headers: headers});
                let request = new Request(`https://api.allorigins.win/raw?url=${encodeURIComponent(sensor.url)}`, {method: 'GET', headers: headers});
                fetch(request)
                .then(response => response.text())
                .then(data => JSON.parse(data))
                .then(json => {
                    let temp = '-';
                    let precip = '-';
                    let hum = '-'
                    let wind = '-';
                    let date = datestr;

                    if (json['noDatos'] == undefined) {
                        temp = json['temperatura']+' / conge('+json['t_congel']+') / subsuelo('+json['t_subsuelo']+') / super('+json['t_super']+')';
                        precip = json['tiempo_Presente']+' / cant('+json['c_Precipitaciones']+') / i('+json['i_Precipitaciones']+') / n('+json['n_Precipitacion']+') / agua('+json['alt_agua']+')';
                        hum = json['humedad'];
                        wind = json['tipo_viento']+' / '+json['vel_viento']+' / dir('+json['dir_viento']+')';
                        date = json['fecha'];
                    }
                    
                    let report = '';
                    report += '<li><b>Temperatura:</b> '+temp+'</li>';
                    report += '<li><b>Precipitación:</b> '+precip+'</li>';
                    report += '<li><b>Humedad:</b> '+hum+'</li>';
                    report += '<li><b>Viento:</b> '+wind+'</li>';
                    document.getElementById("info").innerHTML += '<div class="col-md p-2"><div class="card"><div class="card-body"><h5 class="card-title">'+sensor.alias+'</h5><ul class="card-text list-unstyled">'+report+'</ul></div><div class="card-footer"><small id="date-0" class="text-muted">'+date+'</small></div></div></div>';
                    addProgress(10);
                });
            });

            // cameras
            let htmlCard = '<div class="col-md-4 p-2"><div class="card"><img src="#SRC#" class="card-img-top" alt="#ALT#">'
                +'<div class="card-body"><h5 class="card-title">#TITLE#</h5><p class="card-text">#PK#</p></div>'
                +'<div class="card-footer"><small id="date-0" class="text-muted">#DATE#</small></div></div></div>';
            let cameras = [
                { image: "163995", title: "Valsaín", pk: "CL-601 PK 10.8 C", date: "No date", url: "No URL Image" },
                { image: "163996", title: "Navacerrada Cima", pk: "CL-601 PK 24.0 C", date: "No date", url: "No URL Image" },
                { image: "161041", title: "Navacerrada M01", pk: "M-601 PK 18.5 D", date: "No date", url: "No URL Image" },
                { image: "161040", title: "Navacerrada M02", pk: "M-601 PK 15.6 D", date: "No date", url: "No URL Image" },
                { image: "163994", title: "Navacerrada M03", pk: "M-601 PK 12.5 C", date: "No date", url: "No URL Image" },
                { image: "1016", title: "Cerceda", pk: "M-607 PK 50.4 C", date: "No date", url: "No URL Image" },
                
            ];
            // build urls
            cameras.forEach(camera => {
                camera.url = 'https://infocar.dgt.es/etraffic/data/camaras/' + camera.image + '.jpg?horaAct=' + timestamp;
                camera.date = datestr;
            });
            addProgress(10);
            // build cards
            document.getElementById("cameras").innerHTML = '';
            cameras.forEach(camera => {
                document.getElementById("cameras").innerHTML += htmlCard.replace('#SRC#', camera.url).replace('#ALT#', camera.title)
                .replace('#TITLE#', camera.title).replace('#PK#', camera.pk).replace('#DATE#', camera.date);
                addProgress(10);
            });

            // button
            document.getElementById("countdown").addEventListener("click", toggleCountdown, false);

            // finish
            console.info("["+datestr+"] Page loaded")
        }

        loadPage();
    </script>
</body>

</html>